<?php

namespace Tests\Model\Vulnerability;

use Entity\Beneficiary;
use Entity\Household;
use Entity\Person;
use Entity\VulnerabilityCriterion;
use Exception\CsvParserException;
use Model\Vulnerability\CategoryEnum;
use Model\Vulnerability\Resolver;
use Repository\BeneficiaryRepository;
use DateTime;
use Enum\HouseholdAssets;
use Enum\HouseholdShelterStatus;
use Enum\PersonGender;
use DBAL\SectorEnum;
use Symfony\Bundle\FrameworkBundle\Test\KernelTestCase;

class ResolverTest extends KernelTestCase
{
    private const TEST_COUNTRY = 'SYR';
    private const TEST_SECTOR = SectorEnum::LIVELIHOODS;
    private const SCORING_FILE_PATH = __DIR__ . '/../../Resources/Vulnerability/resolver_scoring_<<COUNTRY>>.csv';
    private const WEIGHTING_FILE_PATH = __DIR__ . '/../../Resources/Vulnerability/resolver_weighting.csv';
    private const COUNT_BY_HOUSEHOLD_TEST_VALUE = 2;

    private \Model\Vulnerability\Resolver $resolver;

    /**
     * @throws CsvParserException
     */
    protected function setUp(): void
    {
        $beneficiaryRepositoryMock = $this->createMock(BeneficiaryRepository::class);

        $beneficiaryRepositoryMock->expects($this->any())
            ->method('countByHousehold')
            ->willReturn(self::COUNT_BY_HOUSEHOLD_TEST_VALUE);

        $this->resolver = new Resolver(self::WEIGHTING_FILE_PATH, self::SCORING_FILE_PATH, $beneficiaryRepositoryMock);
    }

    public function testGenderOfHouseholdHead()
    {
        $household = new Household();

        $beneficiary = new Beneficiary();
        $beneficiary->getPerson()->setGender(PersonGender::MALE);
        $beneficiary->setStatus(true);
        $beneficiary->setHousehold($household);

        $household->addMember($beneficiary);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(2, $protocol->getScore(CategoryEnum::HHH_GENDER));
    }

    public function testVulnerabilityHeadOfHouseholdVeryVulnerable()
    {
        $household = new Household();

        $beneficiary = new Beneficiary();
        $beneficiary->setStatus(true);

        $beneficiary->getPerson()->setDateOfBirth(new DateTime('-7 year'));

        $criteriaPregnant = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_PREGNANT);
        $criteriaLactating = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_LACTATING);
        $criteriaDisabled = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_DISABLED);
        $criteriaChronicallyIll = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_CHRONICALLY_ILL);

        $beneficiary->getVulnerabilityCriteria()->add($criteriaDisabled);
        $beneficiary->getVulnerabilityCriteria()->add($criteriaPregnant);
        $beneficiary->getVulnerabilityCriteria()->add($criteriaLactating);
        $beneficiary->getVulnerabilityCriteria()->add($criteriaChronicallyIll);

        $household->addMember($beneficiary);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(14, $protocol->getScore(CategoryEnum::HHH_VULNERABILITY));
    }

    public function testVulnerabilityOfHouseholdMembers()
    {
        $household = new Household();

        $head = new Beneficiary();
        $head->setStatus(true);

        $household->addMember($head);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(1, $protocol->getScore(CategoryEnum::HHM_VULNERABILITY));

        $household->addMember($this->createBeneficiaryByAge(4));
        $household->addMember($this->createBeneficiaryByAge(70));

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(9, $protocol->getScore(CategoryEnum::HHM_VULNERABILITY));

        $criteriaPregnant = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_PREGNANT);
        $criteriaLactating = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_LACTATING);
        $criteriaDisabled = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_DISABLED);
        $criteriaChronicallyIll = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_CHRONICALLY_ILL);

        $vulnerableMember = new Beneficiary();
        $vulnerableMember->setStatus(false);

        $vulnerableMember->getVulnerabilityCriteria()->add($criteriaDisabled);
        $vulnerableMember->getVulnerabilityCriteria()->add($criteriaPregnant);
        $vulnerableMember->getVulnerabilityCriteria()->add($criteriaLactating);
        $vulnerableMember->getVulnerabilityCriteria()->add($criteriaChronicallyIll);

        $household->addMember($vulnerableMember);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(20, $protocol->getScore(CategoryEnum::HHM_VULNERABILITY));
    }

    public function testVulnerabilityHeadOfHouseholdNoVulnerability()
    {
        $household = new Household();

        $beneficiary = new Beneficiary();
        $beneficiary->setStatus(true);

        $household->addMember($beneficiary);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(1, $protocol->getScore(CategoryEnum::HHH_VULNERABILITY));
    }

    public function testShelter()
    {
        $household = new Household();
        $household->setShelterStatus(HouseholdShelterStatus::TENT); //tent

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(1, $protocol->getScore(CategoryEnum::SHELTER));

        $household->setShelterStatus(null);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(0, $protocol->getScore(CategoryEnum::SHELTER));

        $household->setShelterStatus(HouseholdShelterStatus::ROOM_OR_SPACE_IN_PUBLIC_BUILDING);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);

        $this->assertEquals(7, $protocol->getScore(CategoryEnum::SHELTER));
    }

    public function incomePerHouseholdMemberDataProvider()
    {
        return [
            'high vulnerability' => [1, 5000],
            'moderate vulnerability' => [2, 30000],
            'low vulnerability' => [5, 90000],
        ];
    }

    /**
     * @throws CsvParserException
     * @dataProvider incomePerHouseholdMemberDataProvider
     */
    public function testIncomePerHouseholdMember(int $expected, int $income)
    {
        $household = new Household();

        $household->setHouseholdIncome($income);
        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expected, $protocol->getScore(CategoryEnum::INCOME_HHM));
    }

    public function incomeSpentOnFoodDataProvider()
    {
        return [
            'null values' => [null, null, 0],
            'zero values' => [0, 0, 0],
            'low vulnerability' => [100, 1000, 1],
            'high vulnerability' => [800, 1000, 4],
        ];
    }

    /**
     * @throws CsvParserException
     *
     * @dataProvider incomeSpentOnFoodDataProvider
     */
    public function testIncomeSpentOnfFood(?int $incomeSpentOnFood, ?int $householdIncome, int $expectedScore)
    {
        $household = new Household();

        $household->setIncomeSpentOnFood($incomeSpentOnFood);
        $household->setHouseholdIncome($householdIncome);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expectedScore, $protocol->getScore(CategoryEnum::INCOME_FOOD));
    }

    public function productiveAssetsDataProvider()
    {
        return [
            '0 assets' => [[], 0],
            '1 asset' => [[HouseholdAssets::LIVESTOCK], 1],
            '2 assets' => [[HouseholdAssets::LIVESTOCK, HouseholdAssets::MOTORBIKE], 2],
            '6 assets' => [
                [
                    HouseholdAssets::LIVESTOCK,
                    HouseholdAssets::MOTORBIKE,
                    HouseholdAssets::WASHING_MACHINE,
                    HouseholdAssets::AC,
                    HouseholdAssets::CAR,
                    HouseholdAssets::FLATSCREEN_TV,
                ],
                5,
            ],
        ];
    }

    /**
     *
     * @throws CsvParserException
     *
     * @dataProvider productiveAssetsDataProvider
     */
    public function testProductiveAssets(array $assets, int $expectedScore)
    {
        $household = new Household();

        $household->setAssets($assets);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expectedScore, $protocol->getScore(CategoryEnum::ASSETS));
    }

    public function CSIDataProvider()
    {
        return [
            'null value' => [null, 0],
            'high CSI' => [50, 4],
            'mid CSI' => [25, 2],
            'low CSI' => [5, 1],
        ];
    }

    /**
     *
     * @throws CsvParserException
     *
     * @dataProvider CSIDataProvider
     */
    public function testCSI(?int $csiValue, int $expectedScore)
    {
        $household = new Household();
        $household->setCopingStrategiesIndex($csiValue);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expectedScore, $protocol->getScore(CategoryEnum::CSI));
    }

    public function FCSDataProvider()
    {
        return [
            'null values' => [null, 0],
            'high FCS' => [40, 3],
            'med FCS' => [25, 2],
            'low FCS' => [5, 1],
        ];
    }

    /**
     *
     * @throws CsvParserException
     *
     * @dataProvider FCSDataProvider
     */
    public function testFCS(?int $fcsValue, int $expectedScore)
    {
        $household = new Household();
        $household->setFoodConsumptionScore($fcsValue);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expectedScore, $protocol->getScore(CategoryEnum::FCS));
    }

    public function debtDataProvider()
    {
        return [
            'null values' => [null, 0],
            'extreme debt' => [5000, 5],
            'med debt' => [2500, 3],
            'low debt' => [500, 1],
        ];
    }

    /**
     *
     * @throws CsvParserException
     *
     * @dataProvider debtDataProvider
     */
    public function testDebt(?int $debt, int $expectedScore)
    {
        $household = new Household();
        $household->setDebtLevel($debt);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals($expectedScore, $protocol->getScore(CategoryEnum::DEBT));
    }

    public function testAssistanceProvided(): never
    {
        /* $modalityType = new ModalityType();
         $modalityType->setName('Shelter tool kit');

         $distributionData = new DistributionData();
         $distributionData->setDateDistribution(new DateTime('now -1 month'));

         $commodity = new Commodity();
         $commodity->setModalityType($modalityType);
         $commodity->setDistributionData($distributionData);

         $assistanceBeneficiary = new AssistanceBeneficiary();
         $assistanceBeneficiary->setDistributionData($distributionData);

         $household = new Household();
         $household->getDistributionBeneficiaries()->add($assistanceBeneficiary);
             */

        $this->markTestSkipped('assistanceProvided condition needs to be implemented first');
    }

    public function testDependencyRatio()
    {
        $household = new Household();

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(0, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $household->addMember($this->createBeneficiaryByAge(30));

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(1, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $household->addMember($this->createBeneficiaryByAge(7));
        $household->addMember($this->createBeneficiaryByAge(7));

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(2, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $household->addMember($this->createBeneficiaryByAge(70));

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(3, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $vulnerabilityDisabled = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_DISABLED);
        $disabledAdult = $this->createBeneficiaryByAge(30);
        $disabledAdult->getVulnerabilityCriteria()->add($vulnerabilityDisabled);

        $household->addMember($disabledAdult);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(4, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $household->addMember($this->createBeneficiaryByAge(30));
        $household->addMember($this->createBeneficiaryByAge(30));
        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(2, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $household->addMember($this->createBeneficiaryByAge(30));
        $household->addMember($this->createBeneficiaryByAge(30));
        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(1, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));

        $vulnerabilityChronicallyIll = new VulnerabilityCriterion(VulnerabilityCriterion::CRITERION_CHRONICALLY_ILL);
        $chronicallyIllAdult = $this->createBeneficiaryByAge(30);
        $chronicallyIllAdult->getVulnerabilityCriteria()->add($vulnerabilityChronicallyIll);

        $household->addMember($chronicallyIllAdult);

        $protocol = $this->resolver->compute($household, self::TEST_COUNTRY, self::TEST_SECTOR);
        $this->assertEquals(1, $protocol->getScore(CategoryEnum::DEPENDENCY_RATIO));
    }

    private function createBeneficiaryByAge(int $age): Beneficiary
    {
        $beneficiary = new Beneficiary();
        $beneficiary->getPerson()->setDateOfBirth(new DateTime("now -$age years"));
        $beneficiary->setStatus(false);

        return $beneficiary;
    }
}
