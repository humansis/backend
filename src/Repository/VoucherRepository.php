<?php

namespace Repository;

use Doctrine\ORM\NonUniqueResultException;
use Doctrine\ORM\NoResultException;
use Doctrine\ORM\Query\Expr\Join;
use Entity\Booklet;
use Entity\Vendor;

/**
 * VoucherRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class VoucherRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * Get all Vouchers by id
     * @param array  $ids
     * @return mixed
     */
    public function getAllByBookletIds(array $ids)
    {
        $qb = $this->createQueryBuilder("v");
        $q = $qb->leftJoin('v.booklet', 'b')
            ->andWhere('b.id IN (:ids)')
            ->setParameter('ids', $ids);

        return $q->getQuery();
    }

    /**
     * Get queryset for the streamed response
     * @param array  $booklets
     * @return mixed
     */
    public function getAllByBooklets(array $booklets)
    {
        $qb = $this->createQueryBuilder("v");
        $q = $qb->leftJoin("v.booklet", "b")
            ->where("b IN (:booklets)")
            ->setParameter("booklets", $booklets);

        return $q->getQuery();
    }

    public function countByBookletsIds(array $ids) {
        $qb = $this->createQueryBuilder("v");
        $q = $qb->leftJoin("v.booklet", "b")
            ->select('count(v.id)')
            ->where("b.id IN (:ids)")
            ->setParameter("ids", $ids);

        return $q->getQuery()->getSingleScalarResult();
    }

    public function countByBooklets(array $booklets) {
        $qb = $this->createQueryBuilder("v");
        $q = $qb->leftJoin("v.booklet", "b")
            ->select('count(v.id)')
            ->where("b IN (:booklets)")
            ->setParameter("booklets", $booklets);

        return $q->getQuery()->getSingleScalarResult();
    }

    public function countVoucherValue(array $voucherIds): int
    {
        $qb = $this->createQueryBuilder('v')
            ->select('SUM(v.value)')
            ->where('v.id IN (:voucherIds)')
            ->setParameter('voucherIds', $voucherIds);

        try {
            return $qb->getQuery()->getSingleScalarResult();
        } catch (NoResultException | NonUniqueResultException $e) {
            return 0;
        }
    }

    public function findUsedButUnredeemedByVendor(Vendor $vendor)
    {
        $qb = $this->createQueryBuilder("v");
        $q = $qb->select('v')
            ->leftJoin("v.booklet", "b")
            ->leftJoin("v.voucherPurchase", "vp")
            ->leftJoin("v.redemptionBatch", "rb", Join::WITH)
            ->andWhere('vp.vendor = :vendor')
            ->andWhere('vp IS NOT NULL')
            ->andWhere('rb IS NULL')
            ->andWhere('vp.vendor = :vendor')
            ->andWhere('b.status = :bookletUsedStatus')
            ->setParameter("vendor", $vendor)
            ->setParameter("bookletUsedStatus", Booklet::USED)
        ;

        $qb->setParameter('vendor', $vendor);

        return $qb->getQuery()->getResult();
    }
}
