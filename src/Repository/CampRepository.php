<?php

namespace Repository;

use Doctrine\ORM\EntityRepository;
use Entity\Location;
use InputType\CampFilterInputType;

/**
 * CampRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CampRepository extends EntityRepository
{
    public function findByCountry(string $countryISO3, ?CampFilterInputType $filterInputType = null)
    {
        $qb = $this->createQueryBuilder('c')
            ->leftJoin('c.location', 'l');

        if (!is_null($filterInputType)) {
            if ($filterInputType->hasIds()) {
                $qb->andWhere('c.id IN (:ids)')
                    ->setParameter('ids', $filterInputType->getIds());
            }
        }

        $locationRepository = $this->getEntityManager()->getRepository(Location::class);
        $locationRepository->whereCountry($qb, $countryISO3);

        return $qb->getQuery()->getResult();
    }

    public function findByNameAndLocation(string $name, array $location)
    {
        $qb = $this->createQueryBuilder('c')
            ->where('c.name = :name')
            ->setParameter('name', $name);

        for ($i = 4; $i > 0; $i--) {
            $admKey = 'adm' . $i;
            if (isset($location[$admKey])) {
                $qb->leftJoin('c.location', 'l')
                    ->andWhere('l.lvl = :admLevel')
                    ->andWhere('l.id = :admId')
                    ->setParameter('admLevel', $i)
                    ->setParameter('admId', $location[$admKey]);

                return $qb->getQuery()->getOneOrNullResult();
            }
        }

        return $qb->getQuery()->getOneOrNullResult();
    }
}
