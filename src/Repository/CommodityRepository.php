<?php

namespace Repository;

use Doctrine\ORM\EntityRepository;
use Entity\Commodity;
use Doctrine\ORM\Tools\Pagination\Paginator;
use InputType\CommodityFilterInputType;
use InputType\CommodityOfflineFilterInputType;

/**
 * CommodityRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CommodityRepository extends EntityRepository
{
    /**
     * @param CommodityFilterInputType $filter
     *
     * @return Paginator|Commodity[]
     */
    public function findByParams(CommodityFilterInputType $filter): Paginator
    {
        $qbr = $this->createQueryBuilder('c')
            ->andWhere('c.id IN (:ids)')
            ->setParameter('ids', $filter->getIds());

        return new Paginator($qbr);
    }

    /**
     * @param CommodityOfflineFilterInputType $filter
     * @param string $country
     *
     * @return Paginator|Commodity[]
     */
    public function findOfflineByParams(string $country, CommodityOfflineFilterInputType $filter): Paginator
    {
        $qbr = $this->createQueryBuilder('c')
            ->join('c.assistance', 'a')
            ->join('a.project', 'p')
            ->andWhere('p.countryIso3 = :country')
            ->setParameter('country', $country);

        if ($filter->hasNotModalityTypes()) {
            $qbr->andWhere('c.modalityType NOT IN (:modalityTypes)')
                ->setParameter('modalityTypes', $filter->getNotModalityTypes());
        }

        return new Paginator($qbr);
    }

    /**
     * @param string $country
     *
     * @return Commodity[]
     */
    public function findByCountry(string $country): iterable
    {
        $qbr = $this->createQueryBuilder('c')
            ->join('c.assistance', 'a')
            ->join('a.project', 'p')
            ->andWhere('p.countryIso3 = :country')
            ->setParameter('country', $country);

        return $qbr->getQuery()->getResult();
    }
}
