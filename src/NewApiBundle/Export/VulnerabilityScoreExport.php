<?php
declare(strict_types=1);

namespace NewApiBundle\Export;

use BeneficiaryBundle\Entity\Beneficiary;
use BeneficiaryBundle\Model\Vulnerability\CategoryEnum;
use BeneficiaryBundle\Repository\BeneficiaryRepository;
use CommonBundle\Utils\ExportService;
use DistributionBundle\Entity\Assistance;
use DistributionBundle\Entity\AssistanceBeneficiary;
use DistributionBundle\Enum\AssistanceTargetType;
use DistributionBundle\Repository\AssistanceBeneficiaryRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Contracts\Translation\TranslatorInterface;

class VulnerabilityScoreExport
{
    /** @var ExportService */
    private $csvExportService;

    /** @var TranslatorInterface */
    private $translator;

    /** @var EntityManagerInterface */
    private $em;

    /**
     * @var BeneficiaryRepository
     */
    private $beneficiaryRepository;

    /**
     * @var AssistanceBeneficiaryRepository
     */
    private $assistanceBeneficiaryRepository;

    public function __construct(ExportService $exportService,
                                TranslatorInterface $translator,
                                EntityManagerInterface $em,
                                BeneficiaryRepository $beneficiaryRepository,
                                AssistanceBeneficiaryRepository $assistanceBeneficiaryRepository)
    {
        $this->csvExportService = $exportService;
        $this->translator = $translator;
        $this->em = $em;
        $this->beneficiaryRepository = $beneficiaryRepository;
        $this->assistanceBeneficiaryRepository = $assistanceBeneficiaryRepository;
    }

    /**
     * @throws \Doctrine\ORM\NonUniqueResultException
     * @throws \PhpOffice\PhpSpreadsheet\Exception
     * @throws \Doctrine\ORM\NoResultException
     */
    public function export(Assistance $assistance, string $type): ?string
    {
        /** @var AssistanceBeneficiary[] $assistanceBeneficiaries */
        $assistanceBeneficiaries = $this->assistanceBeneficiaryRepository->findByAssistance($assistance);

        $exportableTable = [];
        foreach ($assistanceBeneficiaries as $assistanceBeneficiary) {
            /** @var Beneficiary $beneficiary */
            $beneficiary = $assistanceBeneficiary->getBeneficiary();
            $exportableRow = [];
            $assistanceTargetType = $assistance->getTargetType();
            switch ($assistanceTargetType) {
                case AssistanceTargetType::HOUSEHOLD:
                    $targetType = 'Household ID';
                    $targetId = $beneficiary->getHousehold()->getId();
                    $members = $this->beneficiaryRepository->countByHousehold($beneficiary->getHousehold());
                    break;

                case AssistanceTargetType::INDIVIDUAL:
                    $targetType = 'Beneficiary ID';
                    $targetId = $beneficiary->getId();
                    $members = 1;
                    break;

                default:
                    continue 2;
            }

            /** @var string $scores */
            $scores = $assistanceBeneficiary->getVulnerabilityScores();
            if (!$scores) {
                continue;
            }

            $scores = json_decode($scores, true);

            $exportableRow[$this->translator->trans($targetType)] = $targetId;
            $exportableRow[$this->translator->trans('First Name')] = $beneficiary->getPerson()->getLocalGivenName();
            $exportableRow[$this->translator->trans('Family Name')] = $beneficiary->getPerson()->getLocalFamilyName();
            $exportableRow[$this->translator->trans('Assets')] = $scores[CategoryEnum::ASSETS];
            $exportableRow[$this->translator->trans('Assistance')] = $scores[CategoryEnum::ASSISTANCE];
            $exportableRow[$this->translator->trans('CSI')] = $scores[CategoryEnum::CSI];
            $exportableRow[$this->translator->trans('Debt')] = $scores[CategoryEnum::DEBT];
            $exportableRow[$this->translator->trans('Dependency Ration')] = $scores[CategoryEnum::DEPENDENCY_RATIO];
            $exportableRow[$this->translator->trans('Displacement Status')] = $scores[CategoryEnum::DISPLACEMENT_STATUS];
            $exportableRow[$this->translator->trans('FCS')] = $scores[CategoryEnum::FCS];
            $exportableRow[$this->translator->trans('Head Gender')] = $scores[CategoryEnum::HHH_GENDER];
            $exportableRow[$this->translator->trans('Head Vulnerability')] = $scores[CategoryEnum::HHH_VULNERABILITY];
            $exportableRow[$this->translator->trans('Members Vulnerability')] = $scores[CategoryEnum::HHM_VULNERABILITY];
            $exportableRow[$this->translator->trans('Income Spent On Food')] = $scores[CategoryEnum::INCOME_FOOD];
            $exportableRow[$this->translator->trans('Income Per Member')] = $scores[CategoryEnum::INCOME_HHM];
            $exportableRow[$this->translator->trans('Residence Ownership')] = $scores[CategoryEnum::RESIDENCE_OWNERSHIP];
            $exportableRow[$this->translator->trans('Settlement')] = $scores[CategoryEnum::SETTLEMENT];
            $exportableRow[$this->translator->trans('Shelter')] = $scores[CategoryEnum::SHELTER];
            $exportableRow[$this->translator->trans('Total Score')] = $scores['totalScore'];
            $exportableRow[$this->translator->trans('Total BNFs count')] = $members;

            $exportableTable[] = $exportableRow;
        }

        try {
            return $this->csvExportService->export($exportableTable, 'vulnerabilities', $type);
        } catch (\InvalidArgumentException $ex) {
            return null;
        }
    }
}
