<?php

declare(strict_types=1);

namespace NewApiBundle\Repository;

use CommonBundle\Entity\Location;
use DistributionBundle\Entity\Assistance;
use Doctrine\ORM\QueryBuilder;
use Doctrine\ORM\Tools\Pagination\Paginator;
use InvalidArgumentException;
use NewApiBundle\InputType\AssistanceInstitutionsFilterInputType;
use NewApiBundle\InputType\InstitutionFilterInputType;
use NewApiBundle\InputType\InstitutionOrderInputType;
use NewApiBundle\Request\Pagination;
use NewApiBundle\Entity\Project;

/**
 * InstitutionRepository.
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class InstitutionRepository extends \Doctrine\ORM\EntityRepository
{

    public function getUnarchivedByProject(Project $project)
    {
        $qb = $this->createQueryBuilder("comm");
        $q = $qb->leftJoin("comm.projects", "p")
            ->where("p = :project")
            ->setParameter("project", $project)
            ->andWhere("comm.archived = 0");

        return $q->getQuery()->getResult();
    }

    public function findByParams(?string $iso3, ?InstitutionFilterInputType $filter, ?InstitutionOrderInputType $orderBy = null, ?Pagination $pagination = null)
    {
        $qb = $this->createQueryBuilder('i')
            ->andWhere('i.archived = 0');

        if ($iso3) {
            $qb->leftJoin('i.address', 'a')
                ->leftJoin('a.location', 'l');

            $locationRepository = $this->getEntityManager()->getRepository(Location::class);
            $locationRepository->whereCountry($qb, $iso3);
        }

        if ($filter) {
            if ($filter->hasIds()) {
                $qb->andWhere('i.id IN (:ids)')
                    ->setParameter('ids', $filter->getIds());
            }

            if ($filter->hasProjects()) {
                $qb->leftJoin('i.projects', 'pro')
                    ->andWhere('pro.id IN (:ids)')
                    ->setParameter('ids', $filter->getProjects());
            }

            if ($filter->hasFulltext()) {
                $qb->leftJoin('i.contact', 'per');
                $qb->andWhere('(
                    i.id LIKE :fulltextId OR
                    i.name LIKE :fulltext OR
                    i.latitude LIKE :fulltext OR
                    i.longitude LIKE :fulltext OR
                    per.localGivenName LIKE :fulltext OR 
                    per.localFamilyName LIKE :fulltext OR
                    per.localParentsName LIKE :fulltext OR
                    per.enGivenName LIKE :fulltext OR
                    per.enFamilyName LIKE :fulltext OR
                    per.enParentsName LIKE :fulltext OR
                    per.enParentsName LIKE :fulltext
                )');
                $qb->setParameter('fulltextId', $filter->getFulltext());
                $qb->setParameter('fulltext', '%'.$filter->getFulltext().'%');
            }
        }

        if ($pagination) {
            $qb->setMaxResults($pagination->getLimit());
            $qb->setFirstResult($pagination->getOffset());
        }

        if ($orderBy) {
            $this->addOrderByCommonOrderInputType($qb, $orderBy);
        }

        return new Paginator($qb);
    }

    /**
     * @param Assistance                                 $assistance
     * @param AssistanceInstitutionsFilterInputType|null $filter
     * @param InstitutionOrderInputType|null             $orderBy
     * @param Pagination|null                            $pagination
     *
     * @return Paginator|Assistance[]
     */
    public function findByAssistance(
        Assistance $assistance,
        ?AssistanceInstitutionsFilterInputType $filter,
        ?InstitutionOrderInputType $orderBy = null,
        ?Pagination $pagination = null
    ): Paginator
    {
        $qb = $this->createQueryBuilder('i')
            ->join('i.assistanceBeneficiary', 'ab')
            ->leftJoin('i.contact', 'c')
            ->andWhere('i.archived = 0')
            ->andWhere('ab.assistance = :assistance')
            ->setParameter('assistance', $assistance);

        if ($pagination) {
            $qb->setMaxResults($pagination->getLimit());
            $qb->setFirstResult($pagination->getOffset());
        }

        if ($filter) {
            if ($filter->hasFulltext()) {
                $qb->andWhere('(
                    i.id LIKE :fulltextId OR
                    i.name LIKE :fulltext OR
                    i.latitude LIKE :fulltext OR
                    i.longitude LIKE :fulltext OR
                    c.localGivenName LIKE :fulltext OR 
                    c.localFamilyName LIKE :fulltext OR
                    c.localParentsName LIKE :fulltext OR
                    c.enGivenName LIKE :fulltext OR
                    c.enFamilyName LIKE :fulltext OR
                    c.enParentsName LIKE :fulltext OR
                    c.enParentsName LIKE :fulltext
                )');
                $qb->setParameter('fulltextId', $filter->getFulltext());
                $qb->setParameter('fulltext', '%'.$filter->getFulltext().'%');
            }

            if ($filter->hasIds()) {
                $qb->andWhere('i.id IN (:ids)')
                    ->setParameter('ids', $filter->getIds());
            }
        }

        if ($orderBy) {
            $this->addOrderByCommonOrderInputType($qb, $orderBy);
        }

        return new Paginator($qb);
    }

    private function addOrderByCommonOrderInputType(QueryBuilder $qb, InstitutionOrderInputType $orderBy)
    {
        foreach ($orderBy->toArray() as $name => $direction) {
            switch ($name) {
                case InstitutionOrderInputType::SORT_BY_ID:
                    $qb->orderBy('i.id', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_NAME:
                    $qb->orderBy('i.name', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_LONGITUDE:
                    $qb->orderBy('i.longitude', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_LATITUDE:
                    $qb->orderBy('i.latitude', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_CONTACT_GIVEN_NAME:
                    if (!in_array('c', $qb->getAllAliases())) {
                        $qb->leftJoin('i.contact', 'c');
                    }
                    $qb->orderBy('c.enGivenName', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_CONTACT_FAMILY_NAME:
                    if (!in_array('c', $qb->getAllAliases())) {
                        $qb->leftJoin('i.contact', 'c');
                    }
                    $qb->orderBy('c.enFamilyName', $direction);
                    break;
                case InstitutionOrderInputType::SORT_BY_TYPE:
                    $qb->orderBy('i.type', $direction);
                    break;
                default:
                    throw new InvalidArgumentException('Invalid order by directive '.$name);
            }
        }
    }

    /**
     * @param Project $project
     *
     * @return Paginator
     */
    public function findByProject(Project $project)
    {
        $qbr = $this->createQueryBuilder('i');
        $qbr->leftJoin('i.projects', 'p')
            ->where('p = :project')
            ->setParameter('project', $project)
            ->andWhere('i.archived = 0');

        return new Paginator($qbr);
    }
}
